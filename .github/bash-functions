#!/bin/bash -e

V_MINOR=1
V_PATCH=2

TAG_PREFIX=v
DEV_BRANCH=dev
REMOTE=origin

DEB_PACKAGE=test-workflows

getVersion() {
  cat version
}

setVersion() {
  local version=$1
  echo $version > version
}

getVersionNum() {
  local version=$1
  local index=$2
  local IFS=.
  local nums=($version)
  echo ${nums[index]}
}

nextVersion() {
  local version=$1
  local index=$2
  local IFS=.
  local nums=($version)
  local len=${#nums[@]}
  (( nums[index]++ ))
  while (( ++index < len )); do
    (( nums[index] = 0 ))
  done
  echo "${nums[*]}"
}

isPatchVersion() {
  local version=$1
  local patch=$(getVersionNum $version $V_PATCH)
  [ -n "$patch" ] && [ "$patch" != "0" ]
}

hasBranch() {
  local branch=$1
  git log -1 --format=tformat:%D \
    | sed "s/, /\n/g" \
    | grep -qE "\b${branch}\b"
}

isDevMerge() {
  hasBranch $DEV_BRANCH
}

nextVersionIndex() {
  isDevMerge && echo 1 || echo 2
}

nextBranchVersion() {
  local version=$1
  local index=$(nextVersionIndex)
  nextVersion $version $index
}

existTag() {
  local version=$1
  git ls-remote --exit-code --tags $REMOTE "${TAG_PREFIX}${version}"
}

listTags() {
  git ls-remote --tags $REMOTE "${TAG_PREFIX}*" \
    | awk '{print $2}' \
    | sed 's/^refs\/tags\///'
}

catAdd() {
  cat -
  echo $1
}

prevTag() {
  local version=$1
  local tag="${TAG_PREFIX}${version}"
  listTags \
    | catAdd "$tag" \
    | sort -Vur \
    | grep -m 1 -A 1 -xF "$tag" \
    | tail -n +2
}

# installDevscripts() {
#   sudo apt update && sudo apt install devscripts
# }

changelogEntry() {
  local version=$1
  echo "${DEB_PACKAGE} (${version}) unstable; urgency=medium"
  echo
  sed 's/^/  * /'
  echo
  echo " -- ${DEBFULLNAME} <${DEBEMAIL}>  $(date -R)"
  echo
}

# setGitToken() {
#   local token=$1
#   local user=$(git config --get user.name)
#   local value=$(echo -n "${user}:${token}" | base64 -w 0)
#   git config "http.https://github.com/.extraHeader" "Authorization: Basic ${value}"
# }

updateVersion() {
  local version=$(getVersion)
  if existTag $version; then
    echo "Creating new version"
    version=$(nextVersion $version $V_PATCH)
    echo "Setting project version: ${version}"
    setVersion $version
  else
    echo "Using project version: ${version}"
  fi
}

updateChangelog() {
  local version=$(getVersion)
  local prevTag=$(prevTag $version)
  local head=$(git log -1 --format=%H)
  echo "Fetching commits from ${prevTag} to ${head}"
  git fetch --progress --shallow-exclude=$prevTag $REMOTE $head:changelog
  git log --format=tformat:"(%an) %s" changelog \
    | changelogEntry $version \
    | cat - debian/changelog > debian/changelog.new
  mv debian/changelog.new debian/changelog
}

createTag() {
  local version=$(getVersion)
  git commit -am "Version: ${version}" || true
  git tag "${TAG_PREFIX}${version}"
  git push --tags
  git push
}

setDebIdentity() {
  export DEBFULLNAME="Fra Goi"
  export DEBEMAIL="fragoidev@gmail.com"
}

setGitIdentity() {
  git config user.name frabot
  git config user.email fragoidev@gmail.com
}

createRelease() {
  updateVersion

  setDebIdentity
  updateChangelog

  setGitIdentity
  createTag
}

updateDev() {
  local version=$(getVersion)

  if ! existTag $version; then
    echo "Nothing to do"
    return
  fi

  echo "Merging release: ${version}"
  git pull $REMOTE "${TAG_PREFIX}${version}"

  version=$(nextVersion $version $V_MINOR)
  echo "Setting project version: ${version}"
  setVersion $version

  setGitIdentity
  git commit -am "Next version: ${version}"
  git push
}
