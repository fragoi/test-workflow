#!/bin/bash -e

TAG_PREFIX=v
DEV_BRANCH=dev
REMOTE=origin

DEB_PACKAGE=test-workflows

getVersion() {
  cat version
}

setVersion() {
  local version=$1
  echo $version > version
}

nextVersion() {
  local version=$1
  local index=$2
  local IFS=.
  local nums=($version)
  local len=${#nums[@]}
  (( nums[index]++ ))
  while (( ++index < len )); do
    (( nums[index] = 0 ))
  done
  echo "${nums[*]}"
}

hasBranch() {
  local branch=$1
  git log -1 --format=tformat:%D \
    | sed "s/, /\n/g" \
    | grep -qE "\b${branch}\b"
}

isDevMerge() {
  hasBranch $DEV_BRANCH
}

nextVersionIndex() {
  isDevMerge && echo 1 || echo 2
}

nextBranchVersion() {
  local version=$1
  local index=$(nextVersionIndex)
  nextVersion $version $index
}

hasTag() {
  local version=$1
  # git log -1 --format=oneline "${TAG_PREFIX}${version}" --
  git ls-remote --exit-code --tags $REMOTE "${TAG_PREFIX}${version}"
}

listTags() {
  git ls-remote --tags $REMOTE "${TAG_PREFIX}*" \
    | awk '{print $2}' \
    | sed 's/^refs\/tags\///'
}

catAdd() {
  cat -
  echo $1
}

prevTag() {
  local version=$1
  local tag="${TAG_PREFIX}${version}"
  # git log -1 --tags="${TAG_PREFIX}*" --format=tformat:%D \
  #   | sed "s/, /\n/g" \
  #   | grep "tag: ${TAG_PREFIX}" \
  #   | awk '{print $2}' \
  #   | sort -V
  listTags \
    | catAdd "$tag" \
    | sort -Vur \
    | grep -m 1 -A 1 -xF "$tag" \
    | tail -n +2
}

## Not used
installDevscripts() {
  sudo apt update && sudo apt install devscripts
}

setDebIdentity() {
  export DEBFULLNAME="Fra Goi"
  export DEBEMAIL="fragoidev@gmail.com"
}

changelogEntry() {
  local version=$1
  echo "${DEB_PACKAGE} (${version}) unstable; urgency=medium"
  echo
  sed 's/^/  * /'
  echo
  echo " -- ${DEBFULLNAME} <${DEBEMAIL}>  $(date -R)"
  echo
}

updateChangelog() {
  local version=$1
  local prevTag=$(prevTag $version)
  git fetch --shallow-exclude=$prevTag
  git log --format=tformat:"(%an) %s" ${prevTag}..HEAD \
    | changelogEntry $version \
    | cat - debian/changelog > debian/changelog.new
  mv debian/changelog.new debian/changelog
}

setGitIdentity() {
  git config user.name frabot
  git config user.email fragoidev@gmail.com
}

newRelease() {
  local version=$(getVersion)

  # git fetch --tags --quiet

  if hasTag $version; then
    echo "Creating new version"
    version=$(nextBranchVersion $version)
    setVersion $version
  else
    echo "Using project version"
  fi

  # installDevscripts
  setDebIdentity
  updateChangelog $version

  setGitIdentity
  git commit -am "Version: ${version}" || true
  git tag "${TAG_PREFIX}${version}"
  git push --tags
  git push
}

merge() {
  local branch=$1
  setGitIdentity
  git fetch $REMOTE $branch
  git branch -avv
  git merge $branch
  git push
}
